<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>STAN Assistant Guide | @karmaniverous/entity-client-dynamodb</title><meta name="description" content="Documentation for @karmaniverous/entity-client-dynamodb"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">@karmaniverous/entity-client-dynamodb</a><div id="tsd-toolbar-links"><a href="https://github.com/karmaniverous/entity-client-dynamodb">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="" aria-current="page">STAN Assistant Guide</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="stan-assistant-guide-for-assistants-working-on-this-repo" class="tsd-anchor-link">STAN Assistant Guide (for assistants working on this repo)<a href="#stan-assistant-guide-for-assistants-working-on-this-repo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This guide is for STAN assistants modifying or using this repository’s published library surfaces without importing additional type definitions or documentation from the repo into STAN imports. It is intentionally dense and aims to be complete.</p>
<p>This package has two public entrypoints:</p>
<ul>
<li>Base library: <code>@karmaniverous/entity-client-dynamodb</code></li>
<li>get-dotenv DynamoDB plugin: <code>@karmaniverous/entity-client-dynamodb/get-dotenv</code></li>
</ul>
<p>Rule: do not import from <code>src/**</code> in consumer code; use only package <code>exports</code> entrypoints and their documented surfaces.</p>
<h2 id="repository-quick-context-what-this-repo-is" class="tsd-anchor-link">Repository quick context (what this repo is)<a href="#repository-quick-context-what-this-repo-is" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>This repo provides a DynamoDB client adapter (<code>EntityClient</code>) and a fluent query builder (<code>QueryBuilder</code>) on top of <code>@karmaniverous/entity-manager</code> and AWS SDK v3.</li>
<li>It also ships a get-dotenv plugin for DynamoDB table lifecycle, migration, and local DynamoDB orchestration under the <code>/get-dotenv</code> subpath.</li>
<li>TypeDoc is a gate: <code>typedoc.json</code> includes both entrypoints in <code>entryPoints</code> and includes this guide in <code>projectDocuments</code>.</li>
</ul>
<h2 id="build-and-packaging-invariants-must-keep-true" class="tsd-anchor-link">Build and packaging invariants (must keep true)<a href="#build-and-packaging-invariants-must-keep-true" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>These are “must stay consistent” constraints; many regressions come from violating them.</p>
<ul>
<li>Root entrypoint (<code>.</code>) and subpath entrypoint (<code>./get-dotenv</code>) are distinct surfaces (Option B). They must not be aliases.</li>
<li><code>package.json</code> <code>exports</code> must point to files that actually exist after <code>npm run build</code>:
<ul>
<li>Root JS: <code>dist/mjs/index.js</code>, <code>dist/cjs/index.js</code></li>
<li>Root types: <code>dist/index.d.ts</code></li>
<li>Subpath JS: <code>dist/mjs/get-dotenv/index.js</code>, <code>dist/cjs/get-dotenv/index.js</code></li>
<li>Subpath types: <code>dist/get-dotenv/index.d.ts</code></li>
</ul>
</li>
<li>Rollup externals must treat dependency subpath imports as external (example: <code>@karmaniverous/get-dotenv/cliHost</code> must not be bundled). Bundling transitive dependencies (notably <code>execa</code> → <code>npm-run-path</code> → <code>unicorn-magic</code>) can break builds.</li>
<li>Avoid exporting Zod schema constants in the public docs surface unless you truly intend to document their entire inferred <code>__type</code> trees; prefer exporting a documented config type and keeping schema values <code>@internal</code>.</li>
</ul>
<h2 id="scripts-and-gates-what-done-means" class="tsd-anchor-link">Scripts and gates (what “done” means)<a href="#scripts-and-gates-what-done-means" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>From <code>package.json</code> scripts:</p>
<ul>
<li><code>npm run lint</code> must be clean (no errors; warnings should be treated as “fix” unless explicitly ignored by config).</li>
<li><code>npm run test</code> must pass (Docker-based tests may be skipped if Docker is unavailable).</li>
<li><code>npm run typecheck</code> must pass (<code>tsc &amp;&amp; tsd</code>).</li>
<li><code>npm run docs</code> must pass with 0 warnings (<code>typedoc --emit none</code>), with <code>typedoc.validation.notDocumented: true</code>.</li>
</ul>
<h2 id="public-api-map-what-assistants-may-assume-exists" class="tsd-anchor-link">Public API map (what assistants may assume exists)<a href="#public-api-map-what-assistants-may-assume-exists" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This section is the “replacement” for importing type definitions from the repo: it lists the exported symbols that matter, grouped by entrypoint and intent.</p>
<h3 id="root-entrypoint" class="tsd-anchor-link">Root entrypoint: <code>@karmaniverous/entity-client-dynamodb</code><a href="#root-entrypoint" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Source entrypoint: <code>src/index.ts</code></p>
<p>Exports:</p>
<ul>
<li>EntityClient API (runtime and types):
<ul>
<li><code>EntityClient</code></li>
<li><code>EntityClientOptions</code></li>
<li><code>BatchGetOptions</code></li>
<li><code>BatchWriteOptions</code></li>
<li><code>WaiterConfig</code></li>
<li><code>GetItemOutput</code> (exported helper type)</li>
<li><code>GetItemsOutput</code> (exported helper interface)</li>
<li>Low-level helper: <code>getDocumentQueryArgs</code> (for adapter/tests)</li>
</ul>
</li>
<li>QueryBuilder API:
<ul>
<li><code>QueryBuilder</code></li>
<li><code>createQueryBuilder</code></li>
<li>Helpers: <code>addFilterCondition</code>, <code>addRangeKeyCondition</code>, <code>attributeValueAlias</code></li>
<li>Types: <code>FilterCondition</code>, <code>RangeKeyCondition</code>, <code>IndexParams</code>, <code>QueryCondition*</code> union interfaces/types</li>
</ul>
</li>
<li>Tables API:
<ul>
<li><code>generateTableDefinition</code></li>
<li><code>TranscodeAttributeTypeMap</code></li>
<li><code>defaultTranscodeAttributeTypeMap</code></li>
</ul>
</li>
<li>Type-only re-exports from <code>@karmaniverous/entity-manager</code> for downstream DX:
<ul>
<li><code>EntityItem</code>, <code>EntityItemPartial</code></li>
<li><code>EntityRecord</code>, <code>EntityRecordPartial</code></li>
<li><code>EntityToken</code></li>
<li><code>Projected</code></li>
</ul>
</li>
</ul>
<p>Core “how to use it” principles:</p>
<ul>
<li>Token in → narrowed type out: pass literal entity tokens and const projection tuples to preserve inference.</li>
<li>Domain vs storage: DynamoDB reads return storage records; strip keys via <code>entityManager.removeKeys(entityToken, recordOrRecords)</code> when you need domain shapes.</li>
</ul>
<p>Minimal cookbook:</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">EntityClient</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">generateTableDefinition</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-client-dynamodb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">client</span><span class="hl-1"> = </span><span class="hl-5">new</span><span class="hl-1"> </span><span class="hl-0">EntityClient</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">entityManager</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">tableName:</span><span class="hl-1"> </span><span class="hl-2">&#39;UserTable&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;local&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">createTable</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">BillingMode:</span><span class="hl-1"> </span><span class="hl-2">&#39;PAY_PER_REQUEST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><span class="hl-0">generateTableDefinition</span><span class="hl-1">(</span><span class="hl-4">entityManager</span><span class="hl-1">),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">putItem</span><span class="hl-1">({ </span><span class="hl-4">hashKey2:</span><span class="hl-1"> </span><span class="hl-2">&#39;h&#39;</span><span class="hl-1">, </span><span class="hl-4">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;r&#39;</span><span class="hl-1">, </span><span class="hl-4">a:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> });</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">out</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-0">getItem</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, { </span><span class="hl-4">hashKey2:</span><span class="hl-1"> </span><span class="hl-2">&#39;h&#39;</span><span class="hl-1">, </span><span class="hl-4">rangeKey:</span><span class="hl-1"> </span><span class="hl-2">&#39;r&#39;</span><span class="hl-1"> });</span><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">domain</span><span class="hl-1"> = </span><span class="hl-4">out</span><span class="hl-1">.</span><span class="hl-4">Item</span><span class="hl-1"> &amp;&amp; </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-4">entityManager</span><span class="hl-1">.</span><span class="hl-0">removeKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-4">out</span><span class="hl-1">.</span><span class="hl-4">Item</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>QueryBuilder usage:</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createQueryBuilder</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-client-dynamodb&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">qb</span><span class="hl-1"> = </span><span class="hl-0">createQueryBuilder</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">entityClient:</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-5">const</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">hashKeyToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;hashKey2&#39;</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-5">const</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">qb</span><span class="hl-1">.</span><span class="hl-0">addRangeKeyCondition</span><span class="hl-1">(</span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">  </span><span class="hl-4">property:</span><span class="hl-1"> </span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">operator:</span><span class="hl-1"> </span><span class="hl-2">&#39;between&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">value:</span><span class="hl-1"> { </span><span class="hl-4">from:</span><span class="hl-1"> </span><span class="hl-9">1700000000000</span><span class="hl-1">, </span><span class="hl-4">to:</span><span class="hl-1"> </span><span class="hl-9">1900000000000</span><span class="hl-1"> },</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">withProjection</span><span class="hl-1"> = </span><span class="hl-4">qb</span><span class="hl-1">.</span><span class="hl-0">setProjection</span><span class="hl-1">(</span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">, [</span><span class="hl-2">&#39;created&#39;</span><span class="hl-1">] </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-5">const</span><span class="hl-1">);</span><br/><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">shardQueryMap</span><span class="hl-1"> = </span><span class="hl-4">withProjection</span><span class="hl-1">.</span><span class="hl-0">build</span><span class="hl-1">();</span><br/><br/><span class="hl-5">const</span><span class="hl-1"> { </span><span class="hl-6">items</span><span class="hl-1">, </span><span class="hl-6">pageKeyMap</span><span class="hl-1"> } = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">client</span><span class="hl-1">.</span><span class="hl-4">entityManager</span><span class="hl-1">.</span><span class="hl-0">query</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">entityToken:</span><span class="hl-1"> </span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">item:</span><span class="hl-1"> {},</span><br/><span class="hl-1">  </span><span class="hl-4">shardQueryMap</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">pageSize:</span><span class="hl-1"> </span><span class="hl-9">25</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>Projection invariant (adapter behavior):</p>
<ul>
<li>When any projection is present, the adapter auto-includes the entity <code>uniqueProperty</code> and any explicit sort keys at runtime to preserve dedupe and sort invariants.</li>
</ul>
<h3 id="subpath-entrypoint" class="tsd-anchor-link">Subpath entrypoint: <code>@karmaniverous/entity-client-dynamodb/get-dotenv</code><a href="#subpath-entrypoint" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Source entrypoint: <code>src/get-dotenv/index.ts</code></p>
<p>Purpose:</p>
<ul>
<li>Host-aware get-dotenv plugin + pure services for DynamoDB table lifecycle, migration, and local orchestration.</li>
</ul>
<p>Exports (grouped by usage):</p>
<ul>
<li>Plugin entry:
<ul>
<li><code>dynamodbPlugin</code> (CLI plugin factory; registers commands)</li>
<li><code>DynamodbPluginInstance</code> (typed instance seam; used in command registration modules)</li>
</ul>
</li>
<li>Versioned layout and resolution:
<ul>
<li><code>parseVersionValue</code>, <code>formatVersionToken</code></li>
<li><code>listVersionDirs</code>, <code>listVersionDirEntries</code></li>
<li><code>resolveVersionDir</code></li>
<li><code>getVersionedPathsForToken</code></li>
<li><code>resolveTableFile</code>, <code>resolveTransformFile</code></li>
<li><code>resolveEntityManagerFileWithFallback</code></li>
<li><code>enumerateStepVersions</code></li>
</ul>
</li>
<li>EntityManager dynamic loading:
<ul>
<li><code>loadEntityManagerFromFile</code></li>
<li><code>resolveAndLoadEntityManager</code></li>
</ul>
</li>
<li>YAML table definition utilities (comment-preserving):
<ul>
<li><code>computeGeneratedSections</code></li>
<li><code>composeNewTableYaml</code></li>
<li><code>refreshGeneratedSectionsInPlace</code></li>
<li>Types: <code>GeneratedSections</code>, <code>OverlayOptions</code> (creation-time overlay)</li>
</ul>
</li>
<li>Managed table properties (non-generated keys):
<ul>
<li><code>resolveManagedTableProperties</code></li>
<li><code>assertManagedTablePropertiesInvariants</code></li>
<li><code>pickManagedActualFromProperties</code></li>
<li>Types: <code>TablePropertiesConfig</code>, <code>ManagedTablePropertiesInfo</code></li>
</ul>
</li>
<li>Drift validation:
<ul>
<li><code>validateGeneratedSections</code></li>
<li>Types: <code>ValidateResult</code>, <code>GeneratedDiff</code></li>
</ul>
</li>
<li>Core services (pure; CLI adapters call these):
<ul>
<li>Generate/refresh YAML: <code>generateTableDefinitionAtVersion</code></li>
<li>Validate YAML: <code>validateTableDefinitionAtVersion</code></li>
<li>Create table: <code>createTableAtVersion</code></li>
<li>Delete table: <code>deleteTable</code></li>
<li>Purge table: <code>purgeTable</code></li>
<li>Migrate data: <code>migrateData</code></li>
<li>Local orchestration: <code>startLocal</code>, <code>stopLocal</code>, <code>statusLocal</code>, <code>deriveEndpoint</code></li>
</ul>
</li>
<li>Transform typing helpers:
<ul>
<li><code>defineTransformMap</code></li>
<li>Types: <code>TransformMap</code>, <code>TransformHandler</code>, <code>TransformContext</code></li>
</ul>
</li>
<li>CLI option resolvers (flags &gt; config &gt; defaults; expand flags once):
<ul>
<li><code>resolveLayoutConfig</code></li>
<li><code>resolveGenerateAtVersion</code>, <code>resolveValidateAtVersion</code></li>
<li><code>resolveCreateAtVersion</code>, <code>resolveDelete</code>, <code>resolvePurge</code>, <code>resolveMigrate</code></li>
</ul>
</li>
<li>Note: Commander numeric parsers (e.g., <code>parsePositiveInt</code>) are provided by <code>@karmaniverous/get-dotenv</code>, not exported by this package.</li>
</ul>
<h2 id="get-dotenv-plugin-canonical-mounting-and-config-model-aws-pattern" class="tsd-anchor-link">get-dotenv plugin: canonical mounting and config model (aws-pattern)<a href="#get-dotenv-plugin-canonical-mounting-and-config-model-aws-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Expected usage is as a child of the shipped get-dotenv <code>aws</code> plugin:</p>
<ul>
<li>Commands invoked as <code>aws dynamodb ...</code></li>
<li>Config keyed under <code>plugins[&quot;aws/dynamodb&quot;]</code> (realized mount path)</li>
</ul>
<p>Minimal host composition example:</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createCli</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">awsPlugin</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/plugins&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">dynamodbPlugin</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-client-dynamodb/get-dotenv&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">createCli</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">alias:</span><span class="hl-1"> </span><span class="hl-2">&#39;mycli&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-0">compose</span><span class="hl-4">:</span><span class="hl-1"> (</span><span class="hl-4">p</span><span class="hl-1">) </span><span class="hl-5">=&gt;</span><span class="hl-1"> </span><span class="hl-4">p</span><span class="hl-1">.</span><span class="hl-0">use</span><span class="hl-1">(</span><span class="hl-0">awsPlugin</span><span class="hl-1">().</span><span class="hl-0">use</span><span class="hl-1">(</span><span class="hl-0">dynamodbPlugin</span><span class="hl-1">())),</span><br/><span class="hl-1">})(</span><span class="hl-4">process</span><span class="hl-1">.</span><span class="hl-4">argv</span><span class="hl-1">.</span><span class="hl-0">slice</span><span class="hl-1">(</span><span class="hl-9">2</span><span class="hl-1">));</span>
</code><button type="button">Copy</button></pre>

<p>Config interpolation boundary (critical):</p>
<ul>
<li>Host interpolates plugin config strings once before plugin code runs.</li>
<li>Plugin expands runtime flags once (when resolvers choose to), and must not re-expand config-origin strings.</li>
</ul>
<p>Precedence (every resolver/service adapter must follow):</p>
<ul>
<li>CLI flags (expanded once) &gt; plugin config (already interpolated once) &gt; defaults.</li>
</ul>
<p>Config surface (documented as <code>DynamodbPluginConfig</code>):</p>
<ul>
<li><code>tablesPath</code>, <code>tokens.{table,entityManager,transform}</code>, <code>minTableVersionWidth</code></li>
<li><code>generate.{version,clean,tableProperties}</code></li>
<li><code>validate.{version}</code></li>
<li><code>create.{version,validate,refreshGenerated,force,waiter.maxSeconds,tableNameOverride}</code></li>
<li><code>delete.{tableName,waiter.maxSeconds}</code></li>
<li><code>purge.{tableName}</code></li>
<li><code>migrate.{sourceTable,targetTable,fromVersion,toVersion,pageSize,limit,transformConcurrency,progressIntervalMs}</code></li>
<li><code>local.{port,endpoint,start,stop,status}</code></li>
</ul>
<h2 id="versioned-layout-semantics-tables-lifecycle" class="tsd-anchor-link">Versioned layout semantics (tables lifecycle)<a href="#versioned-layout-semantics-tables-lifecycle" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Default layout under <code>tablesPath</code> (default: <code>tables</code>):</p>
<pre><code class="text">tables/
  table.template.yml       (optional baseline)
  001/
    entityManager.ts|.js   (fallback-aware)
    table.yml|.yaml        (full AWS::DynamoDB::Table resource)
    transform.ts|.js       (optional per-step transforms)
</code><button type="button">Copy</button></pre>

<p>Numeric ordering rules:</p>
<ul>
<li>All version comparisons are numeric, not lexicographic.</li>
<li>Any digit-only directory name is accepted (<code>^\d+$</code>).</li>
<li>Duplicate numeric values across directories (example: <code>1/</code> and <code>001/</code>) are a hard error.</li>
<li><code>minTableVersionWidth</code> is cosmetic padding for formatting tokens when emitting a canonical token; it does not restrict existing dirs.</li>
</ul>
<p>Fallback EntityManager resolution (per requirements):</p>
<ul>
<li>For a requested version V, resolve <code>entityManager.(ts|js)</code> by scanning backward across existing version directories whose numeric value is <code>&lt;= V</code> until a file is found.</li>
<li>Used for both “prev” and “next” in step chains; missing ancestry is an error.</li>
</ul>
<h2 id="yaml-generationrefresh-semantics-comment-preserving" class="tsd-anchor-link">YAML generation/refresh semantics (comment-preserving)<a href="#yaml-generationrefresh-semantics-comment-preserving" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Generated sections:</p>
<ul>
<li><code>Properties.AttributeDefinitions</code></li>
<li><code>Properties.KeySchema</code></li>
<li><code>Properties.GlobalSecondaryIndexes</code></li>
</ul>
<p>Rules:</p>
<ul>
<li>Refresh replaces only the generated nodes under <code>Properties</code>; all other properties and comments are preserved.</li>
<li>Compose-new uses <code>tables/table.template.yml</code> as a baseline if present; otherwise starts from a minimal doc template with a warning banner.</li>
</ul>
<p>Managed table properties (non-generated keys; optional):</p>
<ul>
<li><code>Properties.BillingMode</code></li>
<li><code>Properties.ProvisionedThroughput</code></li>
<li><code>Properties.TableName</code></li>
</ul>
<p>Invariants:</p>
<ul>
<li>If throughput is managed, BillingMode must be managed and must be <code>PROVISIONED</code>, and both RCU/WCU must be present.</li>
<li>If BillingMode is managed as <code>PAY_PER_REQUEST</code>, <code>ProvisionedThroughput</code> must not exist in YAML.</li>
</ul>
<h2 id="drift-validation-semantics" class="tsd-anchor-link">Drift validation semantics<a href="#drift-validation-semantics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Validation checks:</p>
<ul>
<li>Compare YAML’s generated sections to EntityManager output (order-insensitive canonicalization).</li>
<li>If managed table properties are configured, validate those keys for drift too and enforce invariants against the effective YAML.</li>
</ul>
<p>Create flow drift policy:</p>
<ul>
<li>Default: validate drift before create.</li>
<li><code>refreshGenerated</code> updates YAML in place (generated sections + managed properties) before create.</li>
<li><code>force</code> only bypasses drift failure when validate is enabled; it is not a confirmation mechanism.</li>
</ul>
<p>Latest-only create guard (safety invariant):</p>
<ul>
<li>Creating a non-latest version is rejected by default in all environments.</li>
<li>Override requires explicit <code>allowNonLatest: true</code> (<code>--allow-non-latest</code> flag).</li>
</ul>
<h2 id="migration-semantics-stepwise-chain-bounded-memory-strict-boundaries" class="tsd-anchor-link">Migration semantics (stepwise chain; bounded memory; strict boundaries)<a href="#migration-semantics-stepwise-chain-bounded-memory-strict-boundaries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Boundary existence guard (hard):</p>
<ul>
<li>Both <code>fromVersion</code> and <code>toVersion</code> must exist as version directories or migration errors (never silently no-op).</li>
</ul>
<p>Step discovery:</p>
<ul>
<li>Steps are all versions <code>k</code> where <code>from &lt; k &lt;= to</code>, ascending numeric order.</li>
</ul>
<p>Per-step context:</p>
<ul>
<li>Resolve <code>prev</code> EM (fallback-aware) and <code>next</code> EM (fallback-aware).</li>
<li>Optionally load <code>transform.(ts|js)</code> for that step version; missing transform module means default chain for all entities.</li>
</ul>
<p>Default chain (per record):</p>
<ul>
<li>Determine <code>entityToken</code> by parsing the global hash key prefix using <code>prev.config.hashKey</code> and <code>prev.config.shardKeyDelimiter</code> (default delimiter: <code>!</code>).</li>
<li>Convert storage record to domain item: <code>prev.removeKeys(entityToken, record)</code></li>
<li>Convert to next storage record: <code>next.addKeys(entityToken, item)</code></li>
</ul>
<p>Transform semantics:</p>
<ul>
<li>Missing handler for an entity token uses the default chain.</li>
<li>Handler return conventions:
<ul>
<li><code>undefined</code> → drop</li>
<li>single item/record → migrate one</li>
<li>array → fan-out (same entity token)</li>
</ul>
</li>
</ul>
<p>Cross-entity fan-out: not supported (enforced):</p>
<ul>
<li>Returning a fully-keyed storage record whose hash key resolves to a different entity token causes migration to throw (to prevent unsupported cross-entity fan-out).</li>
</ul>
<p>Streaming and batching:</p>
<ul>
<li>Migration scans source table by pages; transforms within the page; writes batches to target via <code>EntityClient.putItems</code>.</li>
<li>No whole-table accumulation; memory is bounded by page + in-flight work.</li>
</ul>
<p>Progress:</p>
<ul>
<li>Progress callback receives <code>{ pages, items, outputs, ratePerSec }</code> at intervals.</li>
</ul>
<p>Transform authoring helper (<code>defineTransformMap</code>):</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">defineTransformMap</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-client-dynamodb/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> { </span><span class="hl-4">ConfigMap</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-4">PrevCM</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../001/entityManager&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> { </span><span class="hl-4">ConfigMap</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-4">NextCM</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;./entityManager&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-3">default</span><span class="hl-1"> </span><span class="hl-0">defineTransformMap</span><span class="hl-1">&lt;</span><span class="hl-7">PrevCM</span><span class="hl-1">, </span><span class="hl-7">NextCM</span><span class="hl-1">&gt;({</span><br/><span class="hl-1">  </span><span class="hl-0">user</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-5">async</span><span class="hl-1"> (</span><span class="hl-4">record</span><span class="hl-1">, { </span><span class="hl-4">prev</span><span class="hl-1">, </span><span class="hl-4">next</span><span class="hl-1"> }) </span><span class="hl-5">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">const</span><span class="hl-1"> </span><span class="hl-6">item</span><span class="hl-1"> = </span><span class="hl-4">prev</span><span class="hl-1">.</span><span class="hl-0">removeKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-4">record</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">next</span><span class="hl-1">.</span><span class="hl-0">addKeys</span><span class="hl-1">(</span><span class="hl-2">&#39;user&#39;</span><span class="hl-1">, </span><span class="hl-4">item</span><span class="hl-1">);</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<h2 id="local-dynamodb-orchestration-config-first-embedded-fallback" class="tsd-anchor-link">Local DynamoDB orchestration (config-first; embedded fallback)<a href="#local-dynamodb-orchestration-config-first-embedded-fallback" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Command subtree: <code>dynamodb local start|status|stop</code> (mounted as <code>aws dynamodb local ...</code> when nested).</p>
<p>Endpoint derivation precedence:</p>
<ol>
<li><code>plugins[&quot;aws/dynamodb&quot;].local.endpoint</code></li>
<li><code>plugins[&quot;aws/dynamodb&quot;].local.port</code> → <code>http://localhost:{port}</code></li>
<li><code>DYNAMODB_LOCAL_ENDPOINT</code> (env)</li>
<li>fallback: <code>http://localhost:${DYNAMODB_LOCAL_PORT ?? '8000'}</code></li>
</ol>
<p>Execution behavior:</p>
<ul>
<li>If config commands exist (<code>local.start|stop|status</code>), run them under a shell in the composed env.</li>
<li>Start waits until the endpoint is healthy (library readiness if available, else SDK probe).</li>
<li>Embedded fallback requires <code>@karmaniverous/dynamodb-local</code> to be installed; otherwise error with guidance.</li>
</ul>
<h2 id="commander-get-dotenv-host-typing-model-do-not-guess" class="tsd-anchor-link">Commander + get-dotenv host typing model (do not guess)<a href="#commander-get-dotenv-host-typing-model-do-not-guess" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This repo uses <code>@commander-js/extra-typings</code> and follows the shipped aws plugin patterns.</p>
<p>Action handler arity:</p>
<ul>
<li>If no <code>.argument(...)</code> is declared: <code>.action(async (opts, thisCommand) =&gt; {})</code></li>
<li>If <code>.argument('[args...]')</code> is declared: <code>.action(async (args, opts, thisCommand) =&gt; {})</code></li>
</ul>
<p>Numeric option parsing (strict):</p>
<ul>
<li>Every numeric option uses a parser (<code>parsePositiveInt</code>, <code>parseNonNegativeInt</code>, <code>parseFiniteNumber</code>) so action handlers receive <code>number</code> at runtime and invalid values fail during parsing.</li>
</ul>
<p>Root bag usage (shell/capture):</p>
<ul>
<li>Read root options via <code>readMergedOptions(thisCommand)</code> and compute capture via <code>shouldCapture(bag.capture)</code>.</li>
</ul>
<p>Config access:</p>
<ul>
<li>Use <code>plugin.readConfig(cli)</code> (instance helper) rather than indexing <code>ctx.pluginConfigs[...]</code> because config is keyed by realized mount path (<code>aws/dynamodb</code>).</li>
</ul>
<p>No optional chaining for ctx:</p>
<ul>
<li>Treat <code>cli.getCtx()</code> as non-optional at action time.</li>
</ul>
<h2 id="where-to-look-in-source-for-assistants-making-changes" class="tsd-anchor-link">Where to look in-source (for assistants making changes)<a href="#where-to-look-in-source-for-assistants-making-changes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Use this section when you need to find the actual implementation quickly.</p>
<ul>
<li>Root entrypoint exports: <code>src/index.ts</code></li>
<li>EntityClient core: <code>src/EntityClient/EntityClient.ts</code></li>
<li>EntityClient helpers: <code>src/EntityClient/methods/*.ts</code></li>
<li>QueryBuilder class and helpers: <code>src/QueryBuilder/**</code></li>
<li>Table definition generation: <code>src/Tables/generateTableDefinition.ts</code></li>
<li>get-dotenv entrypoint exports: <code>src/get-dotenv/index.ts</code></li>
<li>Layout + version resolution: <code>src/get-dotenv/layout.ts</code></li>
<li>EM loader (dynamic import): <code>src/get-dotenv/emLoader.ts</code></li>
<li>YAML utilities: <code>src/get-dotenv/tableDefinition.ts</code>, <code>src/get-dotenv/tableProperties.ts</code></li>
<li>Drift validation: <code>src/get-dotenv/validate.ts</code></li>
<li>Services: <code>src/get-dotenv/services/**</code></li>
<li>CLI plugin registration: <code>src/get-dotenv/cli/plugin/**</code></li>
<li>CLI resolvers: <code>src/get-dotenv/cli/options/**</code></li>
<li>CLI parsers: <code>src/get-dotenv/cli/plugin/parsers.ts</code></li>
</ul>
<p>Tests (co-located):</p>
<ul>
<li>Most modules have <code>*.test.ts</code> nearby; wiring tests under <code>src/get-dotenv/cli/plugin/commands/*.wiring.test.ts</code> verify command registration and option presence.</li>
</ul>
<h2 id="common-failures-and-the-first-place-to-check" class="tsd-anchor-link">Common failures and the “first place to check”<a href="#common-failures-and-the-first-place-to-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>TypeDoc warnings about “referenced but not included”: ensure the referenced type is exported from an entrypoint, or adjust signatures to avoid referring to non-exported types.</li>
<li>TypeDoc <code>notDocumented</code> warnings for anonymous return object properties: prefer named return types (interfaces/types) with documented properties.</li>
<li>Rollup build failing inside a transitive dependency: check <code>rollup.config.ts</code> externals; ensure dependency subpath imports are treated as external.</li>
<li>Drift validation false positives: check canonicalization in <code>src/get-dotenv/validate.ts</code> and ensure YAML nodes are normalized to plain JS before comparison.</li>
<li>Migration “unable to extract entity token”: check EM config hashKey/shardKeyDelimiter expectations and the input record shape.</li>
</ul>
<h2 id="minimal-assistant-checklist-do-before-shipping-changes" class="tsd-anchor-link">Minimal assistant checklist (do before shipping changes)<a href="#minimal-assistant-checklist-do-before-shipping-changes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Identify which entrypoint your change impacts (root vs <code>/get-dotenv</code>) and avoid leaking exports across entrypoints.</li>
<li>Keep TypeDoc warnings at 0.</li>
<li>Keep <code>exports</code> and build outputs consistent (JS + d.ts for both entrypoints).</li>
<li>Ensure CLI adapters remain thin: business rules belong in services, not command registration modules.</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#stan-assistant-guide-for-assistants-working-on-this-repo"><span>STAN <wbr/>Assistant <wbr/>Guide (for assistants working on this repo)</span></a><ul><li><a href="#repository-quick-context-what-this-repo-is"><span>Repository quick context (what this repo is)</span></a></li><li><a href="#build-and-packaging-invariants-must-keep-true"><span>Build and packaging invariants (must keep true)</span></a></li><li><a href="#scripts-and-gates-what-done-means"><span>Scripts and gates (what “done” means)</span></a></li><li><a href="#public-api-map-what-assistants-may-assume-exists"><span>Public <wbr/>API map (what assistants may assume exists)</span></a></li><li><ul><li><a href="#root-entrypoint"><span>Root entrypoint: </span></a></li><li><a href="#subpath-entrypoint"><span>Subpath entrypoint: </span></a></li></ul></li><li><a href="#get-dotenv-plugin-canonical-mounting-and-config-model-aws-pattern"><span>get-<wbr/>dotenv plugin: canonical mounting and config model (aws-<wbr/>pattern)</span></a></li><li><a href="#versioned-layout-semantics-tables-lifecycle"><span>Versioned layout semantics (tables lifecycle)</span></a></li><li><a href="#yaml-generationrefresh-semantics-comment-preserving"><span>YAML generation/refresh semantics (comment-<wbr/>preserving)</span></a></li><li><a href="#drift-validation-semantics"><span>Drift validation semantics</span></a></li><li><a href="#migration-semantics-stepwise-chain-bounded-memory-strict-boundaries"><span>Migration semantics (stepwise chain; bounded memory; strict boundaries)</span></a></li><li><a href="#local-dynamodb-orchestration-config-first-embedded-fallback"><span>Local <wbr/>Dynamo<wbr/>DB orchestration (config-<wbr/>first; embedded fallback)</span></a></li><li><a href="#commander-get-dotenv-host-typing-model-do-not-guess"><span>Commander + get-<wbr/>dotenv host typing model (do not guess)</span></a></li><li><a href="#where-to-look-in-source-for-assistants-making-changes"><span>Where to look in-<wbr/>source (for assistants making changes)</span></a></li><li><a href="#common-failures-and-the-first-place-to-check"><span>Common failures and the “first place to check”</span></a></li><li><a href="#minimal-assistant-checklist-do-before-shipping-changes"><span>Minimal assistant checklist (do before shipping changes)</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/karmaniverous/entity-client-dynamodb" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="../modules.html">@karmaniverous/entity-client-dynamodb</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
